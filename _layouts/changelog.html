---
layout: default
---

<head>
  <meta http-equiv='cache-control' content='no-cache'> 
  <meta http-equiv='expires' content='0'> 
  <meta http-equiv='pragma' content='no-cache'>
</head>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet"  type="text/css" href="{{ '/assets/css/releasetable.css' | relative_url }}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-diff.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/diff-highlight/prism-diff-highlight.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/diff-highlight/prism-diff-highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.js"></script>

<div class="container-fluid">
  <div class="row">
      <div class="col-md-12">
        <table id="releasesTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Date</th>
               <th>
                Work Items
              </br>
              (Introduced in this release)
              </th>
              <th>
                Cumulative Work Items
              </br>
              (Compared to Last Deployed in Production)
              </th>
              <th>Linked with</th>
              <th>Changed Artifacts
                  </br>
                (Compared to Previous Release Candidate)
              </th>
              <th>Deployed To</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% assign releaseData = site.data.processedChangelog[page.branch][page.domain].releases %}
            {% assign reversed_releases = releaseData | reverse %}
            {% for release in  reversed_releases %}
             <tr data-hashid="{{ release.hashId }}" data-domain="{{ page.domain }}" data-workitems="{{ release.workItems | jsonify | escape  }}">
              <td>
                {% assign name_parts = release.names[0] | split: '-' %}
                {% assign build_number = name_parts | last %}
                  <strong><a href="{{ site.data.project.url }}/actions/runs/{{ build_number }}" target="_blank">{{ release.names[0] }}</strong></a>
                 <button class="copy-button" onclick="copyToClipboard(event, '{{ release.names[0] }}')">
                  <i class="fas fa-copy"></i>
                </button>
              </td>
              <td>{{ release.date | date: "%Y-%m-%d %H:%M"  }}</td>
                            <td>
                <ul class="action-links" >
                  {% assign hasItems = false %}
                  {% for workItem in release.workItems %}
                    {% unless workItem == "" %}
                        <li><a href="{{ site.data.project.workItemUrl }}/{{ workItem[0] }}" target="_blank">{{ workItem[0] }}</a></li>
                        {% assign hasItems = true %}
                    {% endunless %}
                  {% endfor %}

                {% unless hasItems %}
                {% if releaseNamesInProd contains releaseName %}
                  <span><b>Last Deployed Release,Check Release Tab</b></span>
                  {% else %}
                    <span>No work items detected,Click to probe!</span>
                  {% endif %}
                {% endunless %}
                </ul>
              </td>
              <td>
                <ul class="action-links" >
                  {% assign hasItems = false %}
                  {% for workItem in release.cumulativeWorkItems %}
                    {% unless workItem == "" %}
                        <li><a href="{{ site.data.project.workItemUrl }}/{{ workItem[0] }}" target="_blank">{{ workItem[0] }}</a></li>
                        {% assign hasItems = true %}
                    {% endunless %}
                  {% endfor %}

                {% unless hasItems %}
                {% if releaseNamesInProd contains releaseName %}
                  <span><b>Last Deployed Release,Check Release Tab</b></span>
                  {% else %}
                    <span>No work items detected,Click to probe!</span>
                  {% endif %}
                {% endunless %}
                </ul>
              </td>
              <td>
                {% for workItem in release.cumulativeWorkItems %}                  
                    {% assign workitemId = workItem[0] %}
                    {% assign workitemDetails = site.data.crossDomainWorkItems[page.branch][workitemId] %}
                    {% if workitemDetails %}
                      <ul class="action-links">
                        {% for detail in workitemDetails %}
                          {% if detail.domain != page.domain %}
                           {% if detail.released != true %}
                             <li><a href="{{ site.url}}/releasedefns/{{page.branch}}/{{detail.domain}}.html" target="_blank">{{workitemId}}-->{{ detail.domain }}:{{ detail.releaseName }}</a></li>
                           {% endif %}
                          {% endif %}
                        {% endfor %}
                      </ul>
                    {% endif %}
                {% endfor %}
              </td>
              <td>
                <ul class="action-links">
                {% if releaseNamesInProd contains releaseName %}
                <span><b>Last Deployed Release,Check Release Tab</b></span>
                {% else %}
                  {% for artifact in release.artifacts %}
                     {%if artifact.from != artifact.to %}
                      <li>{{ artifact.name }}:{{ artifact.version }}</li>
                      {% endif %}
                  {% endfor %}
                {% endif %}
                </ul>
              </td>
              <td>
                  {% for deployed in release.deployedTo %}
                      <span class="badge badge-info">{{ deployed }}</span>
                  {% endfor %}
              </td>
              <td>
                <ul class="action-links">
                {% if releaseNamesInProd contains releaseName %}
                  <li><a class="rollback-release" data-name="{{ release.names[0] }}" data-domain="{{ page.domain }}">üîÑ Attempt a patch</a></li>
                {% else %}
                    <li><a class="initiate-release" data-name="{{ release.names[0] }}" data-domain="{{ page.domain }}">‚úÖ Initiate Release</a></li>
                {% endif %}
                  <li><a class="sandbox-release" data-name="{{ release.names[0] }}" data-domain="{{ page.domain }}"> üåµ Get it on my Sandbox</a></li>
                </ul>
              </td>
             </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  </div>
</div>

{% include modal.html %}

<div id="initiateReleaseModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üôãüèΩ Initiate Release!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="releaseModalMessage"></p>  
        <ul id="linkedReleaseItemsList" class="list-group">
          <!-- Linked work items will be added here dynamically -->
        </ul>
        <p id="infoMessage"></p>  
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="confirmButton" type="button" class="btn btn-primary">Create Release</button>
      </div>
    </div>
  </div>
</div>


<script>


  var yamlDataMap = {};
  var crossDomainWorkItems = {}
  
  {% assign reversed_releases = domain_data.releases | reverse %}
  {% for release in reversed_releases %}
      {% assign release_name = release.names[0] %}
      {% assign parts = release_name | split: '.' %}
      {% assign prefix = parts[0] %}
      {% assign rest = parts | slice: 1, parts.size | join: '.' %}
      {% assign resolved_file_name  = prefix | append: rest %}

      {% assign yaml_data = site.data.releasedefns[page.branch][page.domain][resolved_file_name] %}
      {% if yaml_data %}
        yamlDataMap["{{ release_name }}"] = {{ yaml_data | jsonify }};
      {% endif %}
  {% endfor %}

  crossDomainWorkItems = {{ site.data.crossDomainWorkItems[page.branch] | jsonify }}

  let releaseDataMap = []
  $(document).ready(function () {

    {% assign domain_data = site.data.processedChangelog[page.branch][page.domain] %}
    {% for release in domain_data.releases %}
      releaseDataMap["{{ release.hashId }}"] = {{ release | jsonify }};
    {% endfor %}

    

    $('#releasesTable').DataTable({
      "ordering":false
    });


    $('#releasesTable').on('click', 'tbody tr', function (event) {
      if ($(event.target).closest('.action-links').length) {
        return; // Skip if it's an action link click
      }

      console.log(`Initiate release clicked`)
      const releaseId = $(this).closest('tr').data('hashid');
      const domain = $(this).closest('tr').data('domain');
      const releaseData = releaseDataMap[releaseId];
     
    });

    $('#releasesTable').on('click', '.initiate-release', function () {
      console.log(`Initiate release clicked`)
      const releaseId = $(this).closest('tr').data('hashid');
      const domain = $(this).closest('tr').data('domain');
      const releaseData = releaseDataMap[releaseId];
     
      // Populate and show the new modal instead of opening a new URL
      populateAndShowInitiateReleaseModal(releaseData,domain);
    });


    $('#releasesTable').on('click', '.rollback-release', function () {
      const name = $(this).data('name');
      const domain = $(this).data('domain');
      const url = generateUrl('rollback', name, domain);
      window.open(url, '_blank');
    });

    $('#releasesTable').on('click', '.sandbox-release', function () {
      const name = $(this).data('name');
      const domain = $(this).data('domain');
      const url = generateUrl('sandbox', name, domain);
      window.open(url, '_blank');
    });


    
    $('#releasesTable').DataTable().rows().every(function () {
      var dateCell = this.data()[1]; // Assuming date is in the 2nd column
      var localDate = new Date(dateCell).toLocaleString();
      this.data()[1] = localDate;
      this.invalidate(); // Invalidate to re-draw
    });  
  
   
  });



  function generateUrl(action, selectedReleases,selectedDomains) {
      const repoData = {{ site.data.project | jsonify}}
      const repoUrl = repoData.url;
      let issueTemplate;
      let labels;
      let tittle;
      let additionalParams;
      switch (action) {
        case 'initiate':
          issueTemplate = 'request-a-release-release-envs.yml';
          labels="ops%2Cops-release-request"
          title=`Ops+-+Release+a+domain+into+staging%2Fprod+${selectedDomains.join(',')}`
          additionalParams = `domain=${selectedDomains.join(',')}&releasedefn=${selectedReleases.join(',')}`;
          break;
        case 'sandbox':
          issueTemplate = 'request-a-release.yml';
          labels='labels=ops%2Cops-release-request-non-pipeline-env';
          title='Ops+-+Request+a+release+into+an+org'
          additionalParams = `domain=${selectedDomains.join(',')}&releasedefn=${selectedReleases.join(',')}`;
          break;
      }

      return `${repoUrl}/issues/new?labels=${labels}&template=${issueTemplate}&title=${title}&${additionalParams}`;
  }



  function populateAndShowInitiateReleaseModal(releaseData, currentDomain) {
    const domainReleaseMap = new Map();
    const releaseModalMessage = $('#releaseModalMessage');
    let releaseModalMessageText = `You are about to initiate a release for <b>${currentDomain}:${releaseData.names[0]}</b>`;
    releaseModalMessageText += `<br>Please confirm to continue</br>`;
    releaseModalMessage.html(releaseModalMessageText);
    const listElement = $('#linkedReleaseItemsList');
    listElement.empty(); // Clear existing items

    // Default release domain and name, always selected and disabled
    listElement.append(`<li class="list-group-item"><strong>${currentDomain}</strong></li>`);
    listElement.append(`<li class="list-group-item">
                  <input type="radio" name="releaseSelection${currentDomain}" value="${currentDomain}:${releaseData.names[0]}" checked disabled> ${releaseData.names[0]}
              </li>`);

    for (let workItem of Object.keys(releaseData.cumulativeWorkItems)) {
        if (crossDomainWorkItems[workItem]) {
            crossDomainWorkItems[workItem].forEach(item => {
                if (item.released !== true) {
                    if (!domainReleaseMap.has(item.domain)) {
                        domainReleaseMap.set(item.domain, new Set());
                    }
                    domainReleaseMap.get(item.domain).add(item.releaseName);
                }
            });
        }
    }

    domainReleaseMap.forEach((releaseNames, domain) => {
        if (domain != currentDomain) {
            listElement.append(`<li class="list-group-item"><strong>${domain}</strong></li>`);
            listElement.append(`<li class="list-group-item">
                    <input type="radio" name="releaseSelection${domain}" value="none" checked> None
                </li>`);
            releaseNames.forEach(releaseName => {
                listElement.append(`<li class="list-group-item">
                    <input type="radio" name="releaseSelection${domain}" value="${domain}:${releaseName}"> ${releaseName}
                </li>`);
            });
        }
    });

    $('#confirmButton').off('click').on('click', function() {
        let selectedReleases = [];
        let selectedDomains=[]
        domainReleaseMap.forEach((_, domain) => {
            const selectedValue = $('input[name="releaseSelection' + domain + '"]:checked').val();
            if (selectedValue !== "none") {
                selectedReleases.push(selectedValue);
                selectedDomains.push(domain)
            }
        });

        const url = generateUrl('initiate', selectedReleases,selectedDomains);
        window.open(url, '_blank'); // Open the generated URL in a new tab
        $('#initiateReleaseModal').modal('hide'); // Hide the modal
    });

    $('#initiateReleaseModal').modal('show');
  }



  async function copyToClipboard(event,text) {
    event.stopPropagation()
      try {
          await navigator.clipboard.writeText(text);
          alert('Copied to clipboard: ' + text);
      } catch (err) {
          console.error('Failed to copy text: ', err);
      }
  }
  
</script>